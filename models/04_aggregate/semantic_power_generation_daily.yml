version: 2

semantic_models:
  - name: semantic_power_generation_daily
    description: Semantic model for daily power generation metrics with unit and weather data
    model: ref('aggregate_power_generation_daily')

    # Primary Keys
    entities:
      - name: generation_date
        type: primary
        expr: generation_date

      - name: power_generation_unit
        type: primary
        expr: power_generation_unit_id

    # Dimensions for filtering and grouping
    dimensions:
      # Time dimension
      - name: generation_date
        type: time
        expr: generation_date
        label: "Generation Date"
        type_params:
          time_granularity: day

      # Unit dimensions
      - name: unit_name
        type: categorical
        expr: unit_name
        label: "Unit Name"

      - name: unit_operator
        type: categorical
        expr: unit_operator
        label: "Unit Operator"

      - name: unit_city
        type: categorical
        expr: unit_city
        label: "City"

      - name: unit_state
        type: categorical
        expr: unit_state
        label: "State"

      - name: energy_source
        type: categorical
        expr: energy_source
        label: "Energy Source"

      - name: plant_status
        type: categorical
        expr: plant_status
        label: "Plant Status"

      - name: is_storage
        type: categorical
        expr: is_storage
        label: "Is Storage Facility"

      # Derived dimensions for easier analytics
      - name: energy_type_category
        type: categorical
        expr: |
          case
            when energy_source in ('Water', 'Biomass', 'Waste') then 'Renewable'
            when energy_source in ('Battery Storage', 'Pumped Storage') then 'Storage'
            when energy_source in ('Hard Coal', 'Lignite', 'Natural Gas', 'Nuclear Energy',
                                    'Mineral Oil Products', 'Mine Gas', 'Heat',
                                    'Other Non-Renewable Energy Carriers') then 'Non-Renewable'
            else 'Other'
          end
        label: "Energy Type Category"

      - name: operational_status_group
        type: categorical
        expr: |
          case
            when plant_status in ('In operation', 'Capacity reserve', 'Grid reserve', 'Special grid equipment') then 'Active'
            when plant_status in ('Temporarily shut down', 'Permanently shut down') then 'Inactive'
            else 'Unknown'
          end
        label: "Operational Status"

    # Measures for aggregation
    measures:
      # Generation count metrics
      - name: total_number_of_readings
        description: Total count of hourly readings across all units and days
        label: "Total Number of Readings"
        agg: sum
        expr: number_of_readings
        meta:
          tags: ['generation_metrics', 'count']

      - name: avg_number_of_readings
        description: Average number of hourly readings per day per unit
        label: "Avg Number of Readings"
        agg: avg
        expr: number_of_readings
        meta:
          tags: ['generation_metrics', 'count']

      # Duration metrics
      - name: total_generation_hours
        description: Total hours of power generation across all units and days
        label: "Total Generation Hours"
        agg: sum
        expr: total_duration_hours
        meta:
          tags: ['generation_metrics', 'duration']

      - name: avg_generation_hours
        description: Average generation hours per day per unit
        label: "Avg Generation Hours per Day"
        agg: avg
        expr: total_duration_hours
        meta:
          tags: ['generation_metrics', 'duration']

      # Energy metrics (MWh)
      - name: total_energy_mwh
        description: Total energy generated in megawatt-hours
        label: "Total Energy (MWh)"
        agg: sum
        expr: total_energy_mwh
        meta:
          tags: ['generation_metrics', 'energy', 'key_metric']

      - name: avg_daily_energy_mwh
        description: Average daily energy generation per unit
        label: "Avg Daily Energy (MWh)"
        agg: avg
        expr: total_energy_mwh
        meta:
          tags: ['generation_metrics', 'energy']

      # Power metrics (MW)
      - name: avg_power_output_mw
        description: Average power output across all periods
        label: "Avg Power Output (MW)"
        agg: avg
        expr: avg_power_mw
        meta:
          tags: ['generation_metrics', 'power', 'key_metric']

      - name: min_power_output_mw
        description: Minimum power output recorded
        label: "Min Power Output (MW)"
        agg: min
        expr: min_power_mw
        meta:
          tags: ['generation_metrics', 'power']

      - name: max_power_output_mw
        description: Maximum power output (peak demand)
        label: "Max Power Output (MW)"
        agg: max
        expr: max_power_mw
        meta:
          tags: ['generation_metrics', 'power']

      # Capacity metrics
      - name: total_capacity_mw
        description: Total net electrical capacity across all units
        label: "Total Capacity (MW)"
        agg: sum
        expr: net_electrical_capacity_mw
        meta:
          tags: ['capacity_metrics', 'key_metric']

      - name: avg_capacity_mw
        description: Average net electrical capacity per unit
        label: "Avg Capacity per Unit (MW)"
        agg: avg
        expr: net_electrical_capacity_mw
        meta:
          tags: ['capacity_metrics']

      - name: max_capacity_mw
        description: Maximum net electrical capacity
        label: "Max Capacity (MW)"
        agg: max
        expr: net_electrical_capacity_mw
        meta:
          tags: ['capacity_metrics']

      # Utilization metrics
      - name: avg_capacity_utilization_percent
        description: Average capacity utilization percentage
        label: "Avg Capacity Utilization (%)"
        agg: avg
        expr: avg_capacity_utilization_percent
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['efficiency_metrics', 'utilization', 'key_metric']

      - name: max_capacity_utilization_percent
        description: Maximum (peak) capacity utilization percentage
        label: "Max Capacity Utilization (%)"
        agg: max
        expr: max_capacity_utilization_percent
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['efficiency_metrics', 'utilization']

      # Weather metrics - Temperature
      - name: avg_temperature_c
        description: Average temperature at 2m height in Celsius
        label: "Avg Temperature (°C)"
        agg: avg
        expr: avg_temperature_2m_c
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['weather_metrics', 'temperature']

      - name: min_temperature_c
        description: Minimum temperature recorded
        label: "Min Temperature (°C)"
        agg: min
        expr: min_temperature_2m_c
        meta:
          tags: ['weather_metrics', 'temperature']

      - name: max_temperature_c
        description: Maximum temperature recorded
        label: "Max Temperature (°C)"
        agg: max
        expr: max_temperature_2m_c
        meta:
          tags: ['weather_metrics', 'temperature']

      # Weather metrics - Wind
      - name: avg_wind_speed_10m_mps
        description: Average wind speed at 10m height in meters per second
        label: "Avg Wind Speed 10m (m/s)"
        agg: avg
        expr: avg_wind_speed_10m_mps
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['weather_metrics', 'wind']

      - name: avg_wind_speed_80m_mps
        description: Average wind speed at 80m height (turbine height)
        label: "Avg Wind Speed 80m (m/s)"
        agg: avg
        expr: avg_wind_speed_80m_mps
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['weather_metrics', 'wind']

      # Weather metrics - Solar radiation
      - name: avg_shortwave_radiation_wpm2
        description: Average total shortwave solar radiation in W/m²
        label: "Avg Shortwave Radiation (W/m²)"
        agg: avg
        expr: avg_shortwave_radiation_wpm2
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['weather_metrics', 'solar']

      - name: avg_direct_radiation_wpm2
        description: Average direct solar radiation in W/m²
        label: "Avg Direct Radiation (W/m²)"
        agg: avg
        expr: avg_direct_radiation_wpm2
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['weather_metrics', 'solar']

      - name: avg_diffuse_radiation_wpm2
        description: Average diffuse solar radiation in W/m²
        label: "Avg Diffuse Radiation (W/m²)"
        agg: avg
        expr: avg_diffuse_radiation_wpm2
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['weather_metrics', 'solar']

      # Weather metrics - Precipitation
      - name: total_precipitation_mm
        description: Total precipitation (rain + snow equivalent) in millimeters
        label: "Total Precipitation (mm)"
        agg: sum
        expr: total_precipitation_mm
        meta:
          tags: ['weather_metrics', 'precipitation']

      - name: total_rain_mm
        description: Total rainfall in millimeters
        label: "Total Rainfall (mm)"
        agg: sum
        expr: total_rain_mm
        meta:
          tags: ['weather_metrics', 'precipitation']

      - name: total_snowfall_cm
        description: Total snowfall in centimeters
        label: "Total Snowfall (cm)"
        agg: sum
        expr: total_snowfall_cm
        meta:
          tags: ['weather_metrics', 'precipitation']

      # Weather metrics - Other
      - name: avg_cloud_cover_percent
        description: Average cloud cover percentage (0-100)
        label: "Avg Cloud Cover (%)"
        agg: avg
        expr: avg_cloud_cover_percent
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['weather_metrics', 'atmospheric']

      - name: avg_pressure_hpa
        description: Average atmospheric pressure at mean sea level in hectopascals
        label: "Avg Pressure (hPa)"
        agg: avg
        expr: avg_pressure_msl_hpa
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['weather_metrics', 'atmospheric']

      # Count metrics
      - name: count_of_unit_days
        description: Count of unique unit-day combinations
        label: "Count of Unit-Days"
        agg: count
        expr: power_generation_unit_id
        meta:
          tags: ['generation_metrics', 'count']

      # Calculated business metrics
      - name: load_factor_percent
        description: Load factor - ratio of actual energy generated to theoretical maximum if running at full capacity for 24 hours
        label: "Load Factor (%)"
        agg: avg
        expr: (total_energy_mwh / (net_electrical_capacity_mw * 24)) * 100
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['efficiency_metrics', 'key_metric']

      - name: operational_availability_percent
        description: Percentage of day that unit was generating power (hours operated / 24 hours)
        label: "Operational Availability (%)"
        agg: avg
        expr: (total_duration_hours / 24) * 100
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['efficiency_metrics', 'availability']

      - name: energy_per_mw_capacity
        description: Energy efficiency metric - MWh generated per MW of installed capacity
        label: "Energy per MW Capacity (MWh/MW)"
        agg: avg
        expr: total_energy_mwh / nullif(net_electrical_capacity_mw, 0)
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['efficiency_metrics']

      - name: renewable_energy_mwh
        description: Total energy from renewable sources (Water, Biomass, Waste)
        label: "Renewable Energy (MWh)"
        agg: sum
        expr: |
          case
            when energy_source in ('Water', 'Biomass', 'Waste') then total_energy_mwh
            else 0
          end
        meta:
          tags: ['generation_metrics', 'energy', 'sustainability', 'key_metric']

      - name: non_renewable_energy_mwh
        description: Total energy from non-renewable sources
        label: "Non-Renewable Energy (MWh)"
        agg: sum
        expr: |
          case
            when energy_source in ('Hard Coal', 'Lignite', 'Natural Gas', 'Nuclear Energy',
                                    'Mineral Oil Products', 'Mine Gas', 'Heat',
                                    'Other Non-Renewable Energy Carriers') then total_energy_mwh
            else 0
          end
        meta:
          tags: ['generation_metrics', 'energy', 'sustainability']

      - name: renewable_energy_percentage
        description: Percentage of total energy from renewable sources
        label: "Renewable Energy Share (%)"
        agg: avg
        expr: |
          case
            when total_energy_mwh > 0 then
              (case when energy_source in ('Water', 'Biomass', 'Waste') then 100.0 else 0.0 end)
            else 0
          end
        non_additive_dimension:
          name: generation_date
        meta:
          tags: ['efficiency_metrics', 'sustainability', 'key_metric']
